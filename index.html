<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°±í…ŒìŠ¤íŠ¸ ë„êµ¬ ëª¨ìŒ (ë³€í™˜ & ë³‘í•©)</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify_content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        
        /* ë©”ì¸ ë ˆì´ì•„ì›ƒ: ë‘ ë°•ìŠ¤ë¥¼ ë‚˜ë€íˆ ë°°ì¹˜ */
        .main-wrapper {
            display: flex;
            gap: 30px;
            flex-wrap: wrap; /* í™”ë©´ ì‘ìœ¼ë©´ ì¤„ë°”ê¿ˆ */
            justify_content: center;
            width: 100%;
            max-width: 1000px;
        }

        .container {
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            width: 400px;
            text-align: center;
            display: flex;
            flex-direction: column;
            transition: transform 0.2s;
        }
        
        .container:hover {
            transform: translateY(-5px);
        }

        h2 { margin-bottom: 1.5rem; color: #333; font-weight: 700; font-size: 1.5rem; }
        .badge { 
            display: inline-block; 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 0.8rem; 
            margin-bottom: 10px; 
            color: white; 
            font-weight: bold;
        }
        .badge-blue { background-color: #007bff; }
        .badge-green { background-color: #28a745; }

        .form-group { margin-bottom: 1.2rem; text-align: left; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555; }
        
        input[type="number"], input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-family: 'Malgun Gothic', sans-serif;
            background-color: #fcfcfc;
        }

        button {
            width: 100%;
            padding: 14px;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            font-family: 'Malgun Gothic', sans-serif;
            margin-top: auto; /* ë²„íŠ¼ì„ í•˜ë‹¨ìœ¼ë¡œ ë°€ê¸° */
        }
        
        .btn-blue { background-color: #007bff; }
        .btn-blue:hover { background-color: #0056b3; }
        
        .btn-green { background-color: #28a745; }
        .btn-green:hover { background-color: #218838; }

        .status-msg { margin-top: 1.5rem; font-size: 0.9rem; color: #666; min-height: 20px; }
        .success { color: #28a745 !important; font-weight: bold; }
        .error { color: #dc3545 !important; font-weight: bold; }
        
        .separator {
            width: 100%;
            height: 1px;
            background: #eee;
            margin: 20px 0;
        }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="container">
        <div><span class="badge badge-blue">ê¸°ëŠ¥ 1</span></div>
        <h2>ğŸ“„ ë¡œê·¸ â†’ ì—‘ì…€ ë³€í™˜</h2>
        
        <div class="form-group">
            <label for="lossValue">ì˜ˆìƒ ì†ì ˆ ê¸ˆì•¡ (User Loss Value)</label>
            <input type="number" id="lossValue" value="834">
        </div>

        <div class="form-group">
            <label for="logFile">.log íŒŒì¼ ì„ íƒ</label>
            <input type="file" id="logFile" accept=".log,.txt">
        </div>

        <button class="btn-blue" onclick="processLog()">ë³€í™˜ ë° ë‹¤ìš´ë¡œë“œ</button>
        <div id="statusLog" class="status-msg">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
    </div>

    <div class="container">
        <div><span class="badge badge-green">ê¸°ëŠ¥ 2</span></div>
        <h2>ğŸ“‘ ì—‘ì…€ í†µê³„ ë³‘í•©</h2>

        <div class="form-group">
            <p style="font-size: 0.9rem; color: #666; line-height: 1.4;">
                ì—¬ëŸ¬ ê°œì˜ ê²°ê³¼ ì—‘ì…€ íŒŒì¼(.xlsx)ì„ ì„ íƒí•˜ë©´<br>
                í•˜ë‚˜ì˜ í†µê³„ íŒŒì¼ë¡œ í•©ì³ì¤ë‹ˆë‹¤.
            </p>
        </div>

        <div class="form-group">
            <label for="excelFiles">.xlsx íŒŒì¼ë“¤ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ)</label>
            <input type="file" id="excelFiles" accept=".xlsx" multiple>
        </div>

        <button class="btn-green" onclick="mergeExcels()">ì—‘ì…€ ë³‘í•© ë° ë‹¤ìš´ë¡œë“œ</button>
        <div id="statusMerge" class="status-msg">íŒŒì¼ë“¤ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
    </div>
</div>

<script>
    // --- ê³µí†µ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
    function cleanNumber(valueStr) {
        if (!valueStr) return 0;
        if (typeof valueStr === 'number') return valueStr;
        const cleanStr = String(valueStr).replace(/[^\d.-]/g, '');
        const num = parseFloat(cleanStr);
        return isNaN(num) ? 0 : num;
    }

    function calculateWinRate(winCount, lossCount) {
        if (winCount === 0) return "-";
        const total = winCount + lossCount;
        if (total === 0) return "-";
        return ((winCount / total) * 100).toFixed(3) + "%";
    }

    // ì—‘ì…€ ìŠ¤íƒ€ì¼ë§ í•¨ìˆ˜ (ê³µí†µ ì‚¬ìš©)
    function applyExcelStyle(ws, headerRowIndex1, headerRowIndex2) {
        // ì»¬ëŸ¼ ë„ˆë¹„
        ws['!cols'] = [
            {wch: 22}, {wch: 18}, {wch: 18},
            {wch: 17}, {wch: 17}, {wch: 17}, {wch: 17}, {wch: 17}, {wch: 17}, {wch: 17}, {wch: 17}
        ];

        const range = XLSX.utils.decode_range(ws['!ref']);
        for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                if (!ws[cellAddress]) continue;

                let style = {
                    font: { name: "ë§‘ì€ ê³ ë”•", sz: 11 },
                    alignment: { vertical: "center" },
                    border: {
                        top: { style: "thin", color: { rgb: "D3D3D3" } },
                        bottom: { style: "thin", color: { rgb: "D3D3D3" } },
                        left: { style: "thin", color: { rgb: "D3D3D3" } },
                        right: { style: "thin", color: { rgb: "D3D3D3" } }
                    }
                };

                // í—¤ë” ìŠ¤íƒ€ì¼
                if (R === headerRowIndex1 || R === headerRowIndex2) {
                    style.alignment.horizontal = "center";
                    style.font.bold = true;
                    style.fill = { fgColor: { rgb: "F2F2F2" } };
                } else {
                    // ë°ì´í„° ìŠ¤íƒ€ì¼
                    if (C === 0) {
                        // A2 (Total Rowì˜ ê°’)ì€ ê°€ìš´ë°, ë‚˜ë¨¸ì§€ëŠ” ì™¼ìª½
                        if (R === headerRowIndex1 + 1) style.alignment.horizontal = "center";
                        else style.alignment.horizontal = "left";
                    } else if (C === 1 || C === 2) {
                        style.alignment.horizontal = "center";
                    } else {
                        style.alignment.horizontal = "right";
                    }
                }
                ws[cellAddress].s = style;
            }
        }
    }

    // ==========================================
    // ê¸°ëŠ¥ 1: ë¡œê·¸ ë³€í™˜ ë¡œì§
    // ==========================================
    function processLog() {
        const fileInput = document.getElementById('logFile');
        const lossInput = document.getElementById('lossValue');
        const statusDiv = document.getElementById('statusLog');
        
        if (!fileInput.files.length) {
            statusDiv.innerHTML = "<span class='error'>íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</span>";
            return;
        }

        const userLossValue = parseFloat(lossInput.value) || 0;
        const file = fileInput.files[0];
        const reader = new FileReader();

        statusDiv.innerText = "ì²˜ë¦¬ ì¤‘...";

        reader.onload = function(e) {
            try {
                const text = e.target.result;
                const lines = text.split(/\r?\n/);
                
                let currentRecord = {};
                let currentType = null;
                let currentBatchGroups = [];
                let lastCompleteGroups = [];
                let lastCompleteTotal = null;

                lines.forEach(line => {
                    line = line.trim();
                    const isTotalHeader = line.includes("[Backtest Report]") && line.includes("ë°±í…ŒìŠ¤íŒ… í•©ì‚° ê²°ê³¼");
                    const isGroupHeader = line.includes("[Backtest Report]") && !line.includes("ë°±í…ŒìŠ¤íŒ… í•©ì‚° ê²°ê³¼");

                    if (isTotalHeader || isGroupHeader) {
                        if (Object.keys(currentRecord).length > 0) {
                            const lossCount = currentRecord.raw_loss_count || 0;
                            const winCount = currentRecord.raw_win_count || 0;
                            const profit = currentRecord.raw_profit || 0;
                            const fee = currentRecord.raw_fee || 0;
                            
                            const calculatedLoss = userLossValue * lossCount;
                            const netProfit = profit - calculatedLoss - fee;
                            const unrealizedPnl = (currentRecord.last_equity || 0) - (currentRecord.last_balance || 0);
                            
                            currentRecord.calc_loss_amount = calculatedLoss;
                            currentRecord.calc_net_profit = netProfit;
                            currentRecord.calc_unrealized_pnl = unrealizedPnl;
                            currentRecord.calc_win_rate = calculateWinRate(winCount, lossCount);

                            if (currentType === 'group') currentBatchGroups.push(currentRecord);
                            else if (currentType === 'total') {
                                lastCompleteGroups = [...currentBatchGroups];
                                lastCompleteTotal = currentRecord;
                                currentBatchGroups = [];
                            }
                        }
                        currentRecord = {};
                        currentType = isTotalHeader ? 'total' : 'group';
                        return;
                    }

                    if (line.includes("- Group Name")) currentRecord.GroupName = line.split(":", 2)[1].trim();
                    else if (line.includes("- ì „ì²´ ê·¸ë£¹ ìˆ˜")) currentRecord.TotalGroups = cleanNumber(line.split(":")[1]);
                    else if (line.includes("- ì‹œì‘ì¼")) currentRecord.StartDate = line.split(":", 2)[1].trim();
                    else if (line.includes("- ì¢…ë£Œì¼")) currentRecord.EndDate = line.split(":", 2)[1].trim();
                    else if (line.includes("- Last Balance")) currentRecord.last_balance = cleanNumber(line.split(":")[1]);
                    else if (line.includes("- Last Equity")) currentRecord.last_equity = cleanNumber(line.split(":")[1]);
                    else if (line.includes("- ì´ ìµì ˆ íšŒìˆ˜")) currentRecord.raw_win_count = cleanNumber(line.split(":")[1]);
                    else if (line.includes("- ì´ ì†ì ˆ íšŒìˆ˜")) currentRecord.raw_loss_count = cleanNumber(line.split(":")[1]);
                    else if (line.includes("- ìµì ˆê¸ˆì•¡") || line.includes("- ìµì ˆ ê¸ˆì•¡")) currentRecord.raw_profit = cleanNumber(line.split(":")[1]);
                    else if (line.includes("- Total ìˆ˜ìˆ˜ë£Œ")) currentRecord.raw_fee = cleanNumber(line.split(":")[1]);
                });

                if (Object.keys(currentRecord).length > 0) {
                     const lossCount = currentRecord.raw_loss_count || 0;
                     const calculatedLoss = userLossValue * lossCount;
                     currentRecord.calc_loss_amount = calculatedLoss;
                     currentRecord.calc_net_profit = (currentRecord.raw_profit || 0) - calculatedLoss - (currentRecord.raw_fee || 0);
                     currentRecord.calc_unrealized_pnl = (currentRecord.last_equity || 0) - (currentRecord.last_balance || 0);
                     currentRecord.calc_win_rate = calculateWinRate(currentRecord.raw_win_count || 0, lossCount);

                     if (currentType === 'total') {
                         lastCompleteTotal = currentRecord;
                         lastCompleteGroups = [...currentBatchGroups];
                     }
                }

                if (!lastCompleteTotal) {
                    statusDiv.innerHTML = "<span class='error'>ë°ì´í„° ì—†ìŒ</span>";
                    return;
                }

                const totalHeaders = ["ì „ì²´ ê·¸ë£¹ ìˆ˜", "ì‹œì‘ì¼", "ì¢…ë£Œì¼", "ì´ìµì ˆê¸ˆì•¡", "ì´ì†ì ˆê¸ˆì•¡", "ì´ìˆ˜ìˆ˜ë£Œ", "ì´ìˆ˜ìµê¸ˆ", "ì´ë¯¸ì‹¤í˜„ìˆ˜ìµ", "ì´ìµì ˆíšŒìˆ˜", "ì´ì†ì ˆíšŒìˆ˜", "ì „ì²´ìŠ¹ë¥ "];
                const totalRow = [
                    lastCompleteTotal.TotalGroups, lastCompleteTotal.StartDate, lastCompleteTotal.EndDate,
                    lastCompleteTotal.raw_profit, lastCompleteTotal.calc_loss_amount, lastCompleteTotal.raw_fee,
                    lastCompleteTotal.calc_net_profit, lastCompleteTotal.calc_unrealized_pnl,
                    lastCompleteTotal.raw_win_count, lastCompleteTotal.raw_loss_count, lastCompleteTotal.calc_win_rate
                ];

                const groupHeaders = ["Group Name", "ì‹œì‘ì¼", "ì¢…ë£Œì¼", "ìµì ˆê¸ˆì•¡", "ì†ì ˆê¸ˆì•¡", "ìˆ˜ìˆ˜ë£Œ", "ìˆ˜ìµê¸ˆ", "ë¯¸ì‹¤í˜„ì†ìµ", "ìµì ˆíšŒìˆ˜", "ì†ì ˆíšŒìˆ˜", "ìŠ¹ë¥ "];
                let wsData = [totalHeaders, totalRow, [], [], groupHeaders];

                lastCompleteGroups.forEach(g => {
                    wsData.push([
                        g.GroupName, g.StartDate, g.EndDate,
                        g.raw_profit, g.calc_loss_amount, g.raw_fee,
                        g.calc_net_profit, g.calc_unrealized_pnl,
                        g.raw_win_count, g.raw_loss_count, g.calc_win_rate
                    ]);
                });

                const ws = XLSX.utils.aoa_to_sheet(wsData);
                applyExcelStyle(ws, 0, 4);

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Total_Result");
                XLSX.writeFile(wb, "logic_ë¶„ë‹¨ìœ„_result.xlsx");

                statusDiv.innerHTML = "<span class='success'>âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!</span>";
            } catch (err) {
                console.error(err);
                statusDiv.innerHTML = "<span class='error'>ì˜¤ë¥˜: " + err.message + "</span>";
            }
        };
        reader.readAsText(file, "UTF-8");
    }

    // ==========================================
    // ê¸°ëŠ¥ 2: ì—‘ì…€ ë³‘í•© ë¡œì§
    // ==========================================
    async function mergeExcels() {
        const fileInput = document.getElementById('excelFiles');
        const statusDiv = document.getElementById('statusMerge');

        if (!fileInput.files.length) {
            statusDiv.innerHTML = "<span class='error'>íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</span>";
            return;
        }

        statusDiv.innerText = "ë³‘í•© ì²˜ë¦¬ ì¤‘...";

        // ëˆ„ì  ë³€ìˆ˜ ì´ˆê¸°í™”
        let totalStats = {
            groupCount: 0,
            profit: 0, loss: 0, fee: 0, netProfit: 0, unrealized: 0,
            winCount: 0, lossCount: 0
        };
        let startDate = null;
        let endDate = null;
        let allGroups = [];

        // íŒŒì¼ ì½ê¸° í—¬í¼
        const readExcel = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        resolve(workbook);
                    } catch (err) { reject(err); }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        };

        try {
            for (let i = 0; i < fileInput.files.length; i++) {
                const wb = await readExcel(fileInput.files[i]);
                const ws = wb.Sheets[wb.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(ws, {header: 1}); // Array of Arrays

                if (!jsonData || jsonData.length < 2) continue;

                // 1. ìƒë‹¨ í•©ì‚° (Row 1, Index 1)
                const headerRow = jsonData[0];
                const dataRow = jsonData[1];
                
                // ì»¬ëŸ¼ ì¸ë±ìŠ¤ ì°¾ê¸°
                const getIdx = (name) => headerRow.findIndex(h => h && h.toString().includes(name));

                if (!startDate) startDate = dataRow[getIdx("ì‹œì‘ì¼")];
                if (!endDate) endDate = dataRow[getIdx("ì¢…ë£Œì¼")];

                totalStats.groupCount += cleanNumber(dataRow[getIdx("ì „ì²´ ê·¸ë£¹ ìˆ˜")]);
                totalStats.profit += cleanNumber(dataRow[getIdx("ì´ìµì ˆê¸ˆì•¡")]);
                totalStats.loss += cleanNumber(dataRow[getIdx("ì´ì†ì ˆê¸ˆì•¡")]);
                totalStats.fee += cleanNumber(dataRow[getIdx("ì´ìˆ˜ìˆ˜ë£Œ")]);
                totalStats.netProfit += cleanNumber(dataRow[getIdx("ì´ìˆ˜ìµê¸ˆ")]);
                
                // ë¯¸ì‹¤í˜„ì†ìµ ì»¬ëŸ¼ëª… ì˜ˆì™¸ì²˜ë¦¬
                let unrealIdx = getIdx("ì´ë¯¸ì‹¤í˜„ìˆ˜ìµ");
                if (unrealIdx === -1) unrealIdx = getIdx("ë¯¸ì‹¤í˜„ì†ìµ");
                totalStats.unrealized += cleanNumber(dataRow[unrealIdx]);

                totalStats.winCount += cleanNumber(dataRow[getIdx("ì´ìµì ˆíšŒìˆ˜")]);
                totalStats.lossCount += cleanNumber(dataRow[getIdx("ì´ì†ì ˆíšŒìˆ˜")]);

                // 2. í•˜ë‹¨ ê·¸ë£¹ ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ
                // "Group Name"ì´ ìˆëŠ” í–‰ ì°¾ê¸°
                let splitIdx = -1;
                for(let r=0; r<jsonData.length; r++) {
                    if (jsonData[r][0] && jsonData[r][0].toString().includes("Group Name")) {
                        splitIdx = r;
                        break;
                    }
                }

                if (splitIdx !== -1) {
                    // splitIdx + 1 ë¶€í„° ëê¹Œì§€ê°€ ë°ì´í„°
                    for (let r = splitIdx + 1; r < jsonData.length; r++) {
                        if (jsonData[r] && jsonData[r].length > 0) {
                            allGroups.push(jsonData[r]);
                        }
                    }
                }
            }

            // 3. ìµœì¢… ë°ì´í„° êµ¬ì„±
            // Group Name ê¸°ì¤€ ì •ë ¬
            allGroups.sort((a, b) => {
                const nameA = (a[0] || "").toString();
                const nameB = (b[0] || "").toString();
                return nameA.localeCompare(nameB);
            });

            // ì „ì²´ ìŠ¹ë¥  ì¬ê³„ì‚°
            const totalWinRate = calculateWinRate(totalStats.winCount, totalStats.lossCount);

            const finalHeaders = ["ì „ì²´ ê·¸ë£¹ ìˆ˜", "ì‹œì‘ì¼", "ì¢…ë£Œì¼", "ì´ìµì ˆê¸ˆì•¡", "ì´ì†ì ˆê¸ˆì•¡", "ì´ìˆ˜ìˆ˜ë£Œ", "ì´ìˆ˜ìµê¸ˆ", "ì´ë¯¸ì‹¤í˜„ìˆ˜ìµ", "ì´ìµì ˆíšŒìˆ˜", "ì´ì†ì ˆíšŒìˆ˜", "ì „ì²´ìŠ¹ë¥ "];
            const finalTotalRow = [
                totalStats.groupCount, startDate, endDate,
                totalStats.profit, totalStats.loss, totalStats.fee,
                totalStats.netProfit, totalStats.unrealized,
                totalStats.winCount, totalStats.lossCount, totalWinRate
            ];

            const groupHeaders = ["Group Name", "ì‹œì‘ì¼", "ì¢…ë£Œì¼", "ìµì ˆê¸ˆì•¡", "ì†ì ˆê¸ˆì•¡", "ìˆ˜ìˆ˜ë£Œ", "ìˆ˜ìµê¸ˆ", "ë¯¸ì‹¤í˜„ì†ìµ", "ìµì ˆíšŒìˆ˜", "ì†ì ˆíšŒìˆ˜", "ìŠ¹ë¥ "];
            
            let wsData = [finalHeaders, finalTotalRow, [], [], groupHeaders];
            // ê·¸ë£¹ ë°ì´í„° ì¶”ê°€ (ì»¬ëŸ¼ ê°œìˆ˜ ë§ì¶”ê¸° ìœ„í•´ Slice í˜¹ì€ ë§¤í•‘ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë‚˜, ë³´í†µ êµ¬ì¡°ê°€ ê°™ìœ¼ë¯€ë¡œ push)
            allGroups.forEach(row => wsData.push(row));

            const newWs = XLSX.utils.aoa_to_sheet(wsData);
            applyExcelStyle(newWs, 0, 4);

            const newWb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(newWb, newWs, "Total_Result");
            XLSX.writeFile(newWb, "í†µê³„_ë³‘í•©_ê²°ê³¼.xlsx");

            statusDiv.innerHTML = "<span class='success'>âœ… ë³‘í•© ì™„ë£Œ! ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.</span>";

        } catch (err) {
            console.error(err);
            statusDiv.innerHTML = "<span class='error'>ì˜¤ë¥˜: " + err.message + "</span>";
        }
    }
</script>

</body>
</html>
