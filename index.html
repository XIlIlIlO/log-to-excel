<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°±í…ŒìŠ¤íŠ¸ ë¡œê·¸ ë³€í™˜ê¸° (ë§‘ì€ê³ ë”• ë²„ì „)</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            background-color: #f4f4f9;
            display: flex;
            justify_content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            background: white;
            padding: 2.5rem;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 420px;
            text-align: center;
        }
        h2 { margin-bottom: 1.5rem; color: #333; font-weight: 700; }
        .form-group { margin-bottom: 1.2rem; text-align: left; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555; }
        input[type="number"], input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-family: 'Malgun Gothic', sans-serif;
        }
        button {
            width: 100%;
            padding: 14px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            font-family: 'Malgun Gothic', sans-serif;
        }
        button:hover { background-color: #218838; }
        #status { margin-top: 1.5rem; font-size: 0.95rem; color: #666; min-height: 20px; }
        .download-ready { color: #28a745 !important; font-weight: bold; }
        .error { color: #dc3545 !important; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“Š ë¡œê·¸ â†’ ì—‘ì…€ ë³€í™˜ê¸°</h2>
    
    <div class="form-group">
        <label for="lossValue">ì˜ˆìƒ ì†ì ˆ ê¸ˆì•¡ (User Loss Value)</label>
        <input type="number" id="lossValue" value="834">
    </div>

    <div class="form-group">
        <label for="logFile">.log íŒŒì¼ ì—…ë¡œë“œ</label>
        <input type="file" id="logFile" accept=".log,.txt">
    </div>

    <button onclick="processLog()">ì—‘ì…€ ë³€í™˜ ë° ë‹¤ìš´ë¡œë“œ</button>
    <div id="status">íŒŒì¼ì„ ì„ íƒí•˜ê³  ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</div>
</div>

<script>
    // ìˆ«ì ì •ì œ í•¨ìˆ˜
    function cleanNumber(valueStr) {
        if (!valueStr) return 0;
        const cleanStr = valueStr.replace(/[^\d.-]/g, '');
        const num = parseFloat(cleanStr);
        return isNaN(num) ? 0 : num;
    }

    // ìŠ¹ë¥  ê³„ì‚° í•¨ìˆ˜
    function calculateWinRate(winCount, lossCount) {
        if (winCount === 0) return "-";
        const total = winCount + lossCount;
        if (total === 0) return "-";
        return ((winCount / total) * 100).toFixed(3) + "%";
    }

    function processLog() {
        const fileInput = document.getElementById('logFile');
        const lossInput = document.getElementById('lossValue');
        const statusDiv = document.getElementById('status');
        
        if (!fileInput.files.length) {
            statusDiv.innerHTML = "<span class='error'>íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</span>";
            return;
        }

        const userLossValue = parseFloat(lossInput.value) || 0;
        const file = fileInput.files[0];
        const reader = new FileReader();

        statusDiv.innerText = "ë°ì´í„° ì²˜ë¦¬ ì¤‘...";

        reader.onload = function(e) {
            try {
                const text = e.target.result;
                const lines = text.split(/\r?\n/);
                
                let currentRecord = {};
                let currentType = null;
                let currentBatchGroups = [];
                let lastCompleteGroups = [];
                let lastCompleteTotal = null;

                // --- 1. ë¡œê·¸ íŒŒì‹± ---
                lines.forEach(line => {
                    line = line.trim();
                    const isTotalHeader = line.includes("[Backtest Report]") && line.includes("ë°±í…ŒìŠ¤íŒ… í•©ì‚° ê²°ê³¼");
                    const isGroupHeader = line.includes("[Backtest Report]") && !line.includes("ë°±í…ŒìŠ¤íŒ… í•©ì‚° ê²°ê³¼");

                    if (isTotalHeader || isGroupHeader) {
                        if (Object.keys(currentRecord).length > 0) {
                            const lossCount = currentRecord.raw_loss_count || 0;
                            const winCount = currentRecord.raw_win_count || 0;
                            const profit = currentRecord.raw_profit || 0;
                            const fee = currentRecord.raw_fee || 0;
                            
                            const calculatedLoss = userLossValue * lossCount;
                            const netProfit = profit - calculatedLoss - fee;
                            
                            const lastBalance = currentRecord.last_balance || 0;
                            const lastEquity = currentRecord.last_equity || 0;
                            const unrealizedPnl = lastEquity - lastBalance;
                            
                            currentRecord.calc_loss_amount = calculatedLoss;
                            currentRecord.calc_net_profit = netProfit;
                            currentRecord.calc_unrealized_pnl = unrealizedPnl;
                            currentRecord.calc_win_rate = calculateWinRate(winCount, lossCount);

                            if (currentType === 'group') {
                                currentBatchGroups.push(currentRecord);
                            } else if (currentType === 'total') {
                                lastCompleteGroups = [...currentBatchGroups];
                                lastCompleteTotal = currentRecord;
                                currentBatchGroups = [];
                            }
                        }
                        currentRecord = {};
                        currentType = isTotalHeader ? 'total' : 'group';
                        return;
                    }

                    if (line.includes("- Group Name")) currentRecord.GroupName = line.split(":", 2)[1].trim();
                    else if (line.includes("- ì „ì²´ ê·¸ë£¹ ìˆ˜")) currentRecord.TotalGroups = cleanNumber(line.split(":")[1]);
                    // ë‚ ì§œëŠ” ë¬¸ìì—´ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜´
                    else if (line.includes("- ì‹œì‘ì¼")) currentRecord.StartDate = line.split(":", 2)[1].trim();
                    else if (line.includes("- ì¢…ë£Œì¼")) currentRecord.EndDate = line.split(":", 2)[1].trim();
                    
                    else if (line.includes("- Last Balance")) currentRecord.last_balance = cleanNumber(line.split(":")[1]);
                    else if (line.includes("- Last Equity")) currentRecord.last_equity = cleanNumber(line.split(":")[1]);
                    else if (line.includes("- ì´ ìµì ˆ íšŒìˆ˜")) currentRecord.raw_win_count = cleanNumber(line.split(":")[1]);
                    else if (line.includes("- ì´ ì†ì ˆ íšŒìˆ˜")) currentRecord.raw_loss_count = cleanNumber(line.split(":")[1]);
                    else if (line.includes("- ìµì ˆê¸ˆì•¡") || line.includes("- ìµì ˆ ê¸ˆì•¡")) currentRecord.raw_profit = cleanNumber(line.split(":")[1]);
                    else if (line.includes("- Total ìˆ˜ìˆ˜ë£Œ")) currentRecord.raw_fee = cleanNumber(line.split(":")[1]);
                });

                // ë§ˆì§€ë§‰ ë²„í¼ ì²˜ë¦¬
                if (Object.keys(currentRecord).length > 0) {
                    const lossCount = currentRecord.raw_loss_count || 0;
                    const calculatedLoss = userLossValue * lossCount;
                    const netProfit = (currentRecord.raw_profit || 0) - calculatedLoss - (currentRecord.raw_fee || 0);
                    const unrealizedPnl = (currentRecord.last_equity || 0) - (currentRecord.last_balance || 0);

                    currentRecord.calc_loss_amount = calculatedLoss;
                    currentRecord.calc_net_profit = netProfit;
                    currentRecord.calc_unrealized_pnl = unrealizedPnl;
                    currentRecord.calc_win_rate = calculateWinRate(currentRecord.raw_win_count || 0, lossCount);

                    if (currentType === 'total') {
                        lastCompleteTotal = currentRecord;
                        lastCompleteGroups = [...currentBatchGroups];
                    }
                }

                if (!lastCompleteTotal) {
                    statusDiv.innerHTML = "<span class='error'>ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>";
                    return;
                }

                // --- 2. ì—‘ì…€ ë°ì´í„° ì¤€ë¹„ ---
                const totalHeaders = ["ì „ì²´ ê·¸ë£¹ ìˆ˜", "ì‹œì‘ì¼", "ì¢…ë£Œì¼", "ì´ìµì ˆê¸ˆì•¡", "ì´ì†ì ˆê¸ˆì•¡", "ì´ìˆ˜ìˆ˜ë£Œ", "ì´ìˆ˜ìµê¸ˆ", "ì´ë¯¸ì‹¤í˜„ìˆ˜ìµ", "ì´ìµì ˆíšŒìˆ˜", "ì´ì†ì ˆíšŒìˆ˜", "ì „ì²´ìŠ¹ë¥ "];
                const totalRow = [
                    lastCompleteTotal.TotalGroups,
                    lastCompleteTotal.StartDate,
                    lastCompleteTotal.EndDate,
                    lastCompleteTotal.raw_profit,
                    lastCompleteTotal.calc_loss_amount,
                    lastCompleteTotal.raw_fee,
                    lastCompleteTotal.calc_net_profit,
                    lastCompleteTotal.calc_unrealized_pnl,
                    lastCompleteTotal.raw_win_count,
                    lastCompleteTotal.raw_loss_count,
                    lastCompleteTotal.calc_win_rate
                ];

                const groupHeaders = ["Group Name", "ì‹œì‘ì¼", "ì¢…ë£Œì¼", "ìµì ˆê¸ˆì•¡", "ì†ì ˆê¸ˆì•¡", "ìˆ˜ìˆ˜ë£Œ", "ìˆ˜ìµê¸ˆ", "ë¯¸ì‹¤í˜„ì†ìµ", "ìµì ˆíšŒìˆ˜", "ì†ì ˆíšŒìˆ˜", "ìŠ¹ë¥ "];
                let wsData = [
                    totalHeaders,
                    totalRow,
                    [], [], // ê³µë°± 2ì¤„
                    groupHeaders
                ];

                lastCompleteGroups.forEach(g => {
                    wsData.push([
                        g.GroupName,
                        g.StartDate,
                        g.EndDate,
                        g.raw_profit,
                        g.calc_loss_amount,
                        g.raw_fee,
                        g.calc_net_profit,
                        g.calc_unrealized_pnl,
                        g.raw_win_count,
                        g.raw_loss_count,
                        g.calc_win_rate
                    ]);
                });

                const ws = XLSX.utils.aoa_to_sheet(wsData);

                // --- 3. ìŠ¤íƒ€ì¼ ë° í°íŠ¸ ì ìš© (í•µì‹¬) ---
                
                // (1) ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì • (í”½ì…€ ë‹¨ìœ„ ì¡°ì •)
                ws['!cols'] = [
                    {wch: 22}, // A: Group Name / ì „ì²´ê·¸ë£¹ìˆ˜ (ì•½ 18.75)
                    {wch: 18}, // B: ì‹œì‘ì¼ (ì•½ 16)
                    {wch: 18}, // C: ì¢…ë£Œì¼ (ì•½ 16)
                    {wch: 17}, {wch: 17}, {wch: 17}, {wch: 17}, {wch: 17}, {wch: 17}, {wch: 17}, {wch: 17} // ë‚˜ë¨¸ì§€ 15
                ];

                // (2) ëª¨ë“  ì…€ ìˆœíšŒí•˜ë©° í°íŠ¸ "ë§‘ì€ ê³ ë”•" ì ìš©
                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                        if (!ws[cellAddress]) continue;

                        // ê¸°ë³¸ ìŠ¤íƒ€ì¼: ë§‘ì€ ê³ ë”•, 11pt, ìˆ˜ì§ ê°€ìš´ë° ì •ë ¬
                        let cellStyle = {
                            font: { name: "ë§‘ì€ ê³ ë”•", sz: 11 },
                            alignment: { vertical: "center" },
                            border: {
                                top: { style: "thin", color: { rgb: "D3D3D3" } },
                                bottom: { style: "thin", color: { rgb: "D3D3D3" } },
                                left: { style: "thin", color: { rgb: "D3D3D3" } },
                                right: { style: "thin", color: { rgb: "D3D3D3" } }
                            }
                        };

                        // [ê°œë³„ ì •ë ¬ ê·œì¹™]
                        // A2 ì…€ (ì „ì²´ ê·¸ë£¹ ìˆ˜ ê°’) -> ê°€ìš´ë° ì •ë ¬
                        if (R === 1 && C === 0) {
                            cellStyle.alignment.horizontal = "center";
                        }
                        // B, Cì—´ (ë‚ ì§œ) -> ê°€ìš´ë° ì •ë ¬ (ë³´ê¸° ê¹”ë”í•˜ê²Œ)
                        else if (C === 1 || C === 2) {
                            cellStyle.alignment.horizontal = "center";
                        }
                        // Kì—´ (ìŠ¹ë¥ , Index 10) -> ì˜¤ë¥¸ìª½ ì •ë ¬
                        else if (C === 10) {
                            cellStyle.alignment.horizontal = "right";
                        }

                        ws[cellAddress].s = cellStyle;
                    }
                }

                // --- 4. íŒŒì¼ ì €ì¥ ---
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Total_Result");
                XLSX.writeFile(wb, "logic_ë¶„ë‹¨ìœ„_result.xlsx");

                statusDiv.innerHTML = "<span class='download-ready'>âœ… ë³€í™˜ ì™„ë£Œ! íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œ ë˜ì—ˆìŠµë‹ˆë‹¤.</span>";

            } catch (err) {
                console.error(err);
                statusDiv.innerHTML = "<span class='error'>ì˜¤ë¥˜ ë°œìƒ: " + err.message + "</span>";
            }
        };

        reader.readAsText(file, "UTF-8");
    }
</script>

</body>
</html>
